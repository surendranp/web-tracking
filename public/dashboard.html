<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard</title>
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <style>
    /* Global Styles */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f4f8;
      min-height: 100vh; /* Allows scrolling if content grows */
    }
    /* Navigation Bar Overrides */
    .navbar-custom {
      background-color: rgba(0, 0, 0, 0.75);
    }
    .navbar-custom .navbar-brand,
    .navbar-custom .nav-link {
      color: #fff;
    }
    .navbar-custom .nav-link:hover {
      color: #ddd;
    }

    /* Container that holds sidebar + main content */
    .page-container {
      display: flex;
      height: calc(100vh - 56px); /* Subtract default navbar height */
      overflow: hidden; /* Hide scrollbar if content is bigger than viewport */
    }

    /* Sidebar */
    #sidebar {
      width: 250px;
      background: #333;
      color: #fff;
      padding: 20px;
      overflow-y: auto;
      transition: width 0.3s ease, padding 0.3s ease;
      min-height: calc(100vh - 56px);
    }
    /* Collapsed sidebar: zero width, no padding */
    #sidebar.collapsed {
      width: 0;
      padding: 0;
      overflow: hidden;
    }
    #sidebar h3 {
      margin-top: 0;
      font-size: 1.2rem;
      margin-bottom: 1rem;
      text-align: center;
    }
    #sidebar ul {
      list-style: none;
      padding: 0;
    }
    #sidebar li {
      padding: 10px;
      margin-bottom: 5px;
      cursor: pointer;
      border-bottom: 1px solid #555;
      transition: background 0.3s, transform 0.3s;
    }
    #sidebar li:hover {
      background: #444;
      transform: scale(1.02);
    }
    #sidebar li.active {
      background: #007bff;
      font-weight: bold;
    }

    /* Main Content */
    #mainContent {
      /* We'll dynamically switch columns on toggle. */
      transition: all 0.3s ease;
      padding: 20px 40px;
      animation: fadeIn 1s ease-out;
      overflow-y: auto; /* Let main content scroll if needed */

      /* Center the content with a max-width */
      margin: 0 auto;
      max-width: 1300px; /* Adjust to your liking */
    }

    /* Table Container Styles */
    .table-container {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #ccc;
      margin-bottom: 40px;
      background: #fff;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      animation: fadeInUp 0.8s ease-out;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table, th, td {
      border: 1px solid #ccc;
      text-align: left;
      padding: 8px;
    }
    th {
      background: #f4f4f4;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    /* Headings and Titles */
    h2, h3 {
      color: #333;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <!-- Sticky Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark navbar-custom sticky-top">
    <div class="container-fluid">
      <!-- Toggle Sidebar Button -->

      <a class="navbar-brand" href="/">Tracking Service</a>
      <button
        class="navbar-toggler"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#navbarNav"
        aria-controls="navbarNav"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="/">Home</a>
          </li>
          <!-- Uncomment if needed:
          <li class="nav-item">
            <a class="nav-link" href="/auth/register">Register</a>
          </li>
          -->
          <li class="nav-item">
            <a class="nav-link" href="/auth/login">Login</a>
          </li>
          <!-- Logout as a Bootstrap button -->
          <li class="nav-item">
            <button class="btn btn-danger nav-link" id="logoutButton" style="border: none;">
              Logout
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Page Layout with Sidebar + Main Content -->
  <div class="page-container">
    <!-- Sidebar -->
    <div id="sidebar">
      <h3>Registered Clients</h3>
      <ul id="clientList"></ul>
    </div>

    <!-- Main Content -->
    <div id="mainContent">
      <button
      class="btn btn-secondary me-3"
      type="button"
      id="toggleSidebarBtn">
      Sidebar
    </button>
      <h2>Client Details</h2>

      <!-- Table 1: General Client Tracking Data -->
      <div class="table-container">
        <h3>Tracking Data</h3>
        <table id="clientTable">
          <thead>
            <tr id="tableHead"></tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <!-- Table 2: Elements Data -->
      <div class="table-container">
        <h3>Element Data</h3>
        <table id="elementsTable">
          <thead>
            <tr id="elementsHead"></tr>
          </thead>
          <tbody id="elementsBody"></tbody>
        </table>
      </div>

      <!-- Table 3: Pageviews Data -->
      <div class="table-container">
        <h3>Pageviews Data</h3>
        <table id="pageviewsTable">
          <thead>
            <tr id="pageviewsHead"></tr>
          </thead>
          <tbody id="pageviewsBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Script Section -->
  <script>
    // Toggle Sidebar
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggleSidebarBtn');
    toggleBtn.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
    });

    // Logout function
    document.getElementById('logoutButton').addEventListener('click', async () => {
      try {
        const res = await fetch('/auth/logout', { method: 'POST' });
        if (res.ok) {
          window.location.href = '/';
        } else {
          alert('Logout failed. Please try again.');
        }
      } catch (error) {
        console.error('Logout error:', error);
      }
    });

    // Load clients from API
    async function loadClients() {
      const response = await fetch('/api/clients');
      const clients = await response.json();
      const clientList = document.getElementById('clientList');
      clientList.innerHTML = '';
      clients.forEach((client) => {
        const li = document.createElement('li');
        li.textContent = client.domain;
        li.onclick = () => selectClient(li, client.domain);
        clientList.appendChild(li);
      });
    }

    function selectClient(selectedElement, domain) {
      document
        .querySelectorAll('#clientList li')
        .forEach((li) => li.classList.remove('active'));
      selectedElement.classList.add('active');
      loadClientData(domain);
    }

    async function loadClientData(domain) {
      const response = await fetch(`/api/client-data/${domain}`);
      const data = await response.json();

      if (data.length === 0) {
        document.getElementById('clientTable').style.display = 'none';
        document.getElementById('elementsTable').style.display = 'none';
        document.getElementById('pageviewsTable').style.display = 'none';
        return;
      }

      document.getElementById('clientTable').style.display = 'table';
      document.getElementById('elementsTable').style.display = 'table';
      document.getElementById('pageviewsTable').style.display = 'table';

      // Populate Tables
      populateTrackingTable(data);
      populateElementsTable(data);
      populatePageviewsTable(data);
    }

    function populateTrackingTable(data) {
      const tableHead = document.getElementById('tableHead');
      tableHead.innerHTML = '';
      const tableBody = document.getElementById('tableBody');
      tableBody.innerHTML = '';

      // Table Headers with S.No Column
      const headers = [
        'S.No',
        'URL',
        'Type',
        'IP',
        'Session ID',
        'Buttons',
        'Links',
        'Pageviews',
        'Session Start',
        'Session End',
        'Country',
        'City',
      ];
      headers.forEach((header) => {
        const th = document.createElement('th');
        th.textContent = header;
        tableHead.appendChild(th);
      });

      // Populate Rows
      data.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.appendChild(createCell(index + 1)); // Serial Number
        tr.appendChild(createCell(item.url));
        tr.appendChild(createCell(item.type));
        tr.appendChild(createCell(item.ip));
        tr.appendChild(createCell(item.sessionId));
        tr.appendChild(createCell(formatObject(item.buttons)));
        tr.appendChild(createCell(formatObject(item.links)));
        tr.appendChild(createCell(item.pageviews ? item.pageviews.join(', ') : 'N/A'));
        tr.appendChild(createCell(formatDate(item.sessionStart)));
        tr.appendChild(createCell(formatDate(item.sessionEnd)));
        tr.appendChild(createCell(item.country || 'Unknown'));
        tr.appendChild(createCell(item.city || 'Unknown'));
        tableBody.appendChild(tr);
      });
    }

    function populateElementsTable(data) {
      const elementsHead = document.getElementById('elementsHead');
      elementsHead.innerHTML = '';
      const elementsBody = document.getElementById('elementsBody');
      elementsBody.innerHTML = '';

      // Extract all unique keys from elements objects
      let uniqueKeys = new Set();
      data.forEach((item) => {
        if (item.elements) {
          Object.keys(item.elements).forEach((key) => uniqueKeys.add(key));
        }
      });

      // Create Header Row
      const serialTh = document.createElement('th');
      serialTh.textContent = 'S.No';
      elementsHead.appendChild(serialTh);

      uniqueKeys.forEach((key) => {
        const th = document.createElement('th');
        th.textContent = key;
        elementsHead.appendChild(th);
      });

      // Populate Rows
      data.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.appendChild(createCell(index + 1));
        uniqueKeys.forEach((key) => {
          const value =
            item.elements && item.elements[key] ? item.elements[key] : 'N/A';
          tr.appendChild(createCell(value));
        });
        elementsBody.appendChild(tr);
      });
    }

    function populatePageviewsTable(data) {
      const pageviewsHead = document.getElementById('pageviewsHead');
      pageviewsHead.innerHTML = '';
      const pageviewsBody = document.getElementById('pageviewsBody');
      pageviewsBody.innerHTML = '';

      // Create Header Row
      const serialTh = document.createElement('th');
      serialTh.textContent = 'S.No';
      pageviewsHead.appendChild(serialTh);

      const pageviewTh = document.createElement('th');
      pageviewTh.textContent = 'Pageviews';
      pageviewsHead.appendChild(pageviewTh);

      // Populate Rows
      data.forEach((item, index) => {
        if (item.pageviews && item.pageviews.length > 0) {
          item.pageviews.forEach((pageview, subIndex) => {
            const tr = document.createElement('tr');
            tr.appendChild(createCell(`${index + 1}.${subIndex + 1}`));
            tr.appendChild(createCell(pageview));
            pageviewsBody.appendChild(tr);
          });
        } else {
          const tr = document.createElement('tr');
          tr.appendChild(createCell(index + 1));
          tr.appendChild(createCell('No Pageviews Recorded'));
          pageviewsBody.appendChild(tr);
        }
      });
    }

    function createCell(content) {
      const td = document.createElement('td');
      td.textContent = content || 'N/A';
      return td;
    }

    function formatObject(obj) {
      if (!obj || Object.keys(obj).length === 0) return 'N/A';
      return Object.entries(obj)
        .map(([key, value]) => `${key}: ${value}`)
        .join(', ');
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      const date = new Date(dateStr);
      return date.toLocaleString();
    }

    // Load clients on page load
    loadClients();
  </script>
  <!-- Bootstrap JS Bundle -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>
</body>
</html>
